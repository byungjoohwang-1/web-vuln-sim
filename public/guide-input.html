<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2-1. 입력 데이터 검증 및 표현 가이드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
        /* CSS 스타일은 이전 페이지들과 동일하게 유지 */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; background-color: #f8f9fa; }
        #wrapper { display: flex; width: 100%; height: 100vh; }
        #sidebar-wrapper { min-height: 100vh; width: 280px; background-color: #0f172a; color: #94a3b8; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-brand, .menu-category { padding: 1.5rem 1.25rem; border-bottom: 1px solid #1e293b; }
        .list-group-item.active { background-color: #1e293b; color: #fff; }
        #page-content-wrapper { width: 100%; overflow-y: auto; background-color: #fff; }
        .code-block-header { background-color: #1e293b; color: #fff; padding: 0.5rem 1rem; font-weight: bold; border-radius: 0.25rem 0.25rem 0 0; display: flex; justify-content: space-between; align-items: center; }
        pre[class*="language-"] { margin: 0; border-radius: 0 0 0.25rem 0.25rem; white-space: pre-wrap; word-break: break-all; }
        .code-container { margin-bottom: 30px; }
        .full-width-code .card { min-width: 100%; }
        .full-width-code .col-md-6 { width: 100%; }
    </style>
</head>
<body>

<div id="wrapper">
    <div id="sidebar-wrapper">
        <div class="sidebar-brand">
            <i class="fa-solid fa-cube me-2"></i> Web Security Simulator
            <small>V0.2 BETA | MADE BY JACK</small>
        </div>

        <div class="list-group list-group-flush mt-2">
            <div class="menu-category" data-bs-toggle="collapse" data-bs-target="#menu1"><span><i class="fa-solid fa-bug text-danger me-2"></i> 1. Simulator (10 Attacks)</span><i class="fa-solid fa-chevron-down fa-xs"></i></div>
            <div class="collapse show" id="menu1">
                <a href="sim-sql.html" class="list-group-item list-group-item-action"> SQL Injection</a>
                <a href="sim-cmd.html" class="list-group-item list-group-item-action"> Command Injection</a>
                <a href="sim-xxe.html" class="list-group-item list-group-item-action"> XXE Injection</a>
                <a href="sim-xss.html" class="list-group-item list-group-item-action"> Reflected XSS</a>
                <a href="sim-csrf.html" class="list-group-item list-group-item-action"> CSRF Attack</a>
                <a href="sim-ssrf.html" class="list-group-item list-group-item-action"> SSRF</a>
                <a href="sim-upload.html" class="list-group-item list-group-item-action"> File Upload</a>
                <a href="sim-path.html" class="list-group-item list-group-item-action"> Path Traversal</a>
                <a href="sim-split.html" class="list-group-item list-group-item-action"> HTTP Splitting</a>
                <a href="sim-brute.html" class="list-group-item list-group-item-action"> Brute Force</a>
                <a href="sim-idor.html" class="list-group-item list-group-item-action"> IDOR</a>
                <a href="sim-code.html" class="list-group-item list-group-item-action"> Code Injection</a>
            </div>

            <div class="menu-category mt-1" data-bs-toggle="collapse" data-bs-target="#menu2"><span><i class="fa-solid fa-book me-2"></i> 2. Secure Coding Guidelines</span><i class="fa-solid fa-chevron-down fa-xs"></i></div>
            <div class="collapse show" id="menu2">
                <a href="guide-input.html" class="list-group-item list-group-item-action active"><i class="fa-regular fa-file-lines"></i> 2-1. 입력 데이터 검증 및 표현</a>
                <a href="guide-security.html" class="list-group-item list-group-item-action"><i class="fa-solid fa-shield-halved"></i> 2-2. 보안 기능</a>
                <a href="sim-time-state.html" class="list-group-item list-group-item-action"><i class="fa-solid fa-hourglass-half"></i> 2-3. 시간 및 상태</a>
                <a href="sim-error-handling.html" class="list-group-item list-group-item-action"><i class="fa-solid fa-bug"></i> 2-4. 에러 처리</a>
                <a href="sim-quality.html" class="list-group-item list-group-item-action"><i class="fa-solid fa-check-double"></i> 2-5. 코드 품질</a>
                <a href="sim-encap.html" class="list-group-item list-group-item-action"><i class="fa-solid fa-box-open"></i> 2-6. 캡슐화 및 API 오용</a>
            </div>
        </div>
    </div>
    
    <div id="page-content-wrapper">
        <div class="container-fluid p-5">
            <h1 class="mb-4 text-primary"><i class="fa-regular fa-file-lines me-2"></i> 2-1. 입력 데이터 검증 및 표현 (17개 항목)</h1>
            <p class="lead">외부 입력 데이터를 안전하게 검증하고 표현하여 SQL Injection, XSS, Path Traversal 등의 공격을 방어하는 가이드입니다.</p>
            <hr>
            
            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-filter me-2"></i> 1. SQL 삽입</h2>
            [cite_start]<p class="text-secondary">SQL Injection을 방어하기 위해 Prepared Statement를 사용하거나, 특수문자를 제한합니다[cite: 5595].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Java - 취약한 코드</span><span class="badge bg-light text-dark">SQL Injection</span></div>
                        <pre><code class="language-java">/* 취약한 코드 (Java JDBC API) */
String gubun = request.getParameter("gubun");
// 외부 입력값을 문자열로 바로 사용
String sql = "SELECT * FROM board WHERE b_gubun = '" + gubun  + "'";
Statement stmt = con.createStatement();
ResultSet rs = stmt.executeQuery(sql); [cite_start]// 공격 가능한 구문 실행 [cite: 5602]
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Java - 안전한 코드</span><span class="badge bg-light text-dark">Fix: Prepared Statement</span></div>
                        <pre><code class="language-java">/* 안전한 코드 (Java JDBC API) */
String gubun = request.getParameter("gubun");
String sql = "SELECT * FROM board WHERE b_gubun = ?"; // Placeholder 사용
PreparedStatement pstmt = con.prepareStatement(sql);
pstmt.setString(1, gubun); [cite_start]// 입력값을 문자열로 취급하여 쿼리 구조 변경 방지 [cite: 5607]
ResultSet rs = pstmt.executeQuery();
</code></pre>
                    </div>
                </div>
            </div>

            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-terminal me-2"></i> 2. 코드 삽입</h2>
            [cite_start]<p class="text-secondary">공격자가 소프트웨어의 의도된 동작을 변경하도록 임의 코드를 삽입하여 비정상적으로 동작하게 합니다[cite: 5642]. [cite_start]Python에서는 `eval()`, `exec()` 함수 사용 시 취약합니다[cite: 242].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">eval() 사용</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python) [cite: 270]
def route(request):
    message = request.POST.get('message', "")
    # 외부 입력값을 검증 없이 eval 함수에 전달할 경우 의도하지 않은 코드가 실행될 수 있어 위험하다
    ret = eval(message) 
    return render(request, '/success.html', {'data':ret})
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 입력값 검증</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python) [cite: 288]
def route(request):
    message = request.POST.get('message', "")
    
    # 사용자 입력을 영문, 숫자로 제한하며, 특수문자 포함 시 에러 반환
    [cite_start]if message.isalnum(): [cite: 286]
        ret = eval(message)
        return render(request, '/success.html', {'data':ret})
    else:
        [cite_start]return render(request, '/error.html') [cite: 293]
</code></pre>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-folder-open me-2"></i> 3. 경로 조작 및 자원 삽입</h2>
            [cite_start]<p class="text-secondary">외부 입력값을 자원(파일, 소켓의 포트 등)의 식별자로 사용하는 경우, 사전에 정의된 리스트에 포함된 식별자만 사용하도록 해야 합니다[cite: 375].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Java - 취약한 코드</span><span class="badge bg-light text-dark">경로 조작</span></div>
                        <pre><code class="language-java">/* 취약한 코드 (Java) */
String fileName = request.getParameter("P");
// ... (생략)
// 외부 입력값이 검증 없이 파일처리에 수행
[cite_start]fis = new FileInputStream("C:/datas/" + fileName); [cite: 5675] // 임의 파일 접근 가능
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Java - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 경로 문자열 제거</span></div>
                        <pre><code class="language-java">/* 안전한 코드 (Java) */
String fileName = request.getParameter("P");
[cite_start]// 외부 입력받은 값에서 경로순회 문자열 (/, \, .. 등)을 제거 [cite: 5679]
filename = filename.replaceAll("..", "")
                   .replaceAll("/",  "")
                   .replaceAll("\\\\", ""); 

fis = new FileInputStream("C:/datas/" + fileName);
</code></pre>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-code me-2"></i> 4. 크로스사이트 스크립트 (XSS)</h2>
            [cite_start]<p class="text-secondary">외부 입력값 또는 출력값에 스크립트가 삽입되지 못하도록 문자열 치환 함수를 사용하거나, HTML 태그를 허용해야 하는 경우 화이트리스트 기반의 태그만 허용하도록 해야 합니다[cite: 594, 595].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">`mark_safe` 오용</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Django mark_safe) [cite: 621]
from django.utils.safestring import mark_safe
# ...
profile_url  = request.POST.get('profile_url')
profile_name = request.POST.get('profile_name')
object_link = '<a href="{}">{}</a>'.format(profile_url, profile_name)
# mark_safe 함수는 Django의 XSS escape 정책을 따르지 않아 보호 무력화
object_link = mark_safe(object_link) 
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: HTML 이스케이프</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python Flask/Jinja2 예시) [cite: 745]
import html
# ...
def search():
    search_keyword = request.form.get('search_keyword')
    # html.escape() 함수를 사용하여 특수 문자 변환
    escape_keyword = html.escape(search_keyword) 
    
    # &lt;script&gt;가 &amp;lt;script&amp;gt;로 변환되어 실행 방지
    return render_template('search.html', search_keyword=escape_keyword)
</code></pre>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-sliders me-2"></i> 5. 운영체제 명령어 삽입</h2>
            [cite_start]<p class="text-secondary">외부 입력값 내에 시스템 명령어를 포함하는 경우 멀티라인 및 리다이렉트 문자 등을 필터링하고 명령을 수행할 파일명과 옵션을 제한해야 합니다[cite: 777].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">os.system() 사용</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python) [cite: 796]
import os
def execute_command(request):
    app_name_string = request.POST.get('app_name', "")
    # 입력 파라미터를 제한하지 않아 외부 입력값으로 전달된 모든 프로그램이 실행될 수 있음
    os.system(app_name_string)
    return render(request, '/success.html')
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 화이트리스트 프로그램</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python) [cite: 818, 805]
import os
ALLOW_PROGRAM = ['notepad', 'calc'] # 허용된 프로그램 화이트리스트

def execute_command(request):
    app_name_string = request.POST.get('app_name', "")
    
    # 입력받은 파라미터가 허용된 시스템 명령어 목록에 포함되는지 검사
    [cite_start]if app_name_string not in ALLOW_PROGRAM: [cite: 813]
        return render(request, '/error.html', {'error': '허용되지 않은 프로그램입니다.'})
        
    os.system(app_name_string)
</code></pre>
                    </div>
                </div>
            </div>

            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-file-arrow-up me-2"></i> 6. 위험한 형식 파일 업로드</h2>
            [cite_start]<p class="text-secondary">서버에서 실행 가능한 스크립트 파일(`.jsp`, `.php` 등)의 업로드를 허용하여, 공격자가 웹 쉘을 실행해 시스템을 제어할 수 있습니다[cite: 893].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">확장자 검증 없음</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python Django) [cite: 928]
from django.core.files.storage import FileSystemStorage
def file_upload(request):
    upload_file = request.FILES['upload_file']
    # 파일에 대한 크기, 개수, 확장자 등을 검증하지 않음
    fs = FileSystemStorage(location='media/screenshot', base_url='media/screenshot')
    filename = fs.save(upload_file.name, upload_file)
    # 위험한 형식의 파일이 시스템에 업로드 될 수 있음
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 확장자 화이트리스트</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python Django) [cite: 981, 979]
import os
# ...
WHITE_LIST_EXT = ['.jpg', '.jpeg', '.png'] # 허용하는 확장자는 화이트리스트로 관리

def file_upload_secure(request):
    # ... (파일 크기 및 Content-Type 검사 로직 생략)
    
    upload_file = request.FILES['upload_file']
    file_name, file_ext = os.path.splitext(upload_file.name)

    # 파일 확장자 검사
    [cite_start]if file_ext.lower() not in WHITE_LIST_EXT: [cite: 979]
        [cite_start]return render(request, '/error.html', {'error': '파일 타입 오류'}) [cite: 981]
        
    # 안전한 파일명만 저장
    # fs.save(upload_file.name, upload_file)
</code></pre>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-link me-2"></i> 7. 신뢰되지 않는 URL 주소로 자동접속 연결</h2>
            [cite_start]<p class="text-secondary">사용자 입력값을 외부 사이트 주소로 사용하여 피싱 공격(Open Redirect)에 노출됩니다[cite: 1010]. [cite_start]리다이렉션을 허용하는 모든 URL을 서버 측 화이트리스트로 관리해야 합니다[cite: 1015].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">URL 검증 없음</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python Django) [cite: 1035]
from django.shortcuts import redirect
def redirect_url(request):
    url_string = request.POST.get('url', "")
    # 사용자 입력에 포함된 URL 주소로 리다이렉트 하는 경우 피싱 사이트 노출
    return redirect(url_string) 
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 화이트리스트 URL</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python Django) [cite: 1068, 1063]
from django.shortcuts import render, redirect
ALLOW_URL_LIST = ['127.0.0.1', 'https://login.myservice.com', '/notice'] # 화이트리스트

def redirect_url_secure(request):
    url_string = request.POST.get('url', "")
    
    # 이동할 수 있는 URL 범위를 제한하여 위험한 사이트의 접근을 차단하고 있다
    [cite_start]if url_string not in ALLOW_URL_LIST: [cite: 1063]
        return render(request, '/error.html', {'error':'허용되지 않는 주소입니다.'})
        
    [cite_start]return redirect(url_string) [cite: 1068]
</code></pre>
                    </div>
                </div>
            </div>

            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-file-code me-2"></i> 8. 부적절한 XML 외부 개체 참조 (XXE)</h2>
            [cite_start]<p class="text-secondary">취약한 XML 파서가 외부 엔티티를 처리할 때 공격자가 삽입한 공격 구문이 동작되어 서버 파일 접근, 정보 노출 등이 발생할 수 있습니다[cite: 1097].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">외부 엔티티 허용</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python xml.sax) [cite: 1151]
from xml.sax import make_parser
from xml.sax.handler import feature_external_ges

parser = make_parser()
# 외부 일반 엔티티를 포함하는 설정을 True로 적용할 경우 취약하다
parser.setFeature(feature_external_ges, True) 

doc = parseString(request.body.decode('utf-8'), parser=parser)
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: DTD 비활성화</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python xml.sax) [cite: 1190]
from xml.sax import make_parser
from xml.sax.handler import feature_external_ges

parser = make_parser()
# 외부 일반 엔티티를 False로 설정하여 비활성화
parser.setFeature(feature_external_ges, False) 

doc = parseString(request.body.decode('utf-8'), parser=parser)
</code></pre>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-sitemap me-2"></i> 9. XML 삽입</h2>
            [cite_start]<p class="text-secondary">검증되지 않은 외부 입력값이 **XPath나 XQuery** 쿼리문을 생성하는 데 사용되어, 허가되지 않은 데이터를 조회하거나 인증을 우회할 수 있습니다[cite: 1226].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">XPath 문자열 결합</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python lxml) [cite: 1253]
from lxml import etree
def parse_xml(request):
    user_name  = request.POST.get('user_name', "")
    # 검증되지 않은 외부 입력값 user_name을 사용한 안전하지 않은 질의문
    query = "/collection/users/user[@name=" + user_name + "]/home/text()"
    elmts = root.xpath(query)
    # user_name에 ' or 'a'='a 와 같은 공격 문자열 삽입 가능
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 바인딩 변수 사용</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python lxml) [cite: 1283, 1285]
from lxml import etree
def parse_xml_secure(request):
    user_name = request.POST.get('user_name', "")
    # 외부 입력값을 paramname으로 인자화 해서 사용
    [cite_start]query = '/collection/users/user[@name = $paramname]/home/text()' [cite: 1283]
    # root.xpath 함수에 바인딩하여 쿼리 구조 변경을 방지
    [cite_start]elmts = root.xpath(query, paramname=user_name) [cite: 1285]
</code></pre>
                    </div>
                </div>
            </div>

            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-people-group me-2"></i> 10. LDAP 삽입</h2>
            [cite_start]<p class="text-secondary">외부 입력값을 LDAP 조회를 위한 필터 생성에 사용될 경우, 공격자가 LDAP 쿼리문의 내용을 마음대로 변경할 수 있습니다[cite: 1304].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">문자열 포맷 사용</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python ldap3) [cite: 1350]
def ldap_query(request):
    search_keyword = request.POST.get('search_keyword', "")
    # 사용자 입력을 필터링하지 않고 질의문에 사용
    search_str = '(&(objectclass=%s))' % search_keyword 
    # search_keyword에 *와 같은 문자가 입력되면 권한 상승 가능
    conn.search('dc=company.dc=com', search_str, attributes=['sn', 'cn'])
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 이스케이프 처리</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python ldap3) [cite: 1402, 1404]
from ldap3.utils.conv import escape_filter_chars

def ldap_query_secure(request):
    search_keyword = request.POST.get('search_keyword', "")
    
    # 1. escape_filter_chars를 사용해 공격에 사용될 수 있는 문자를 이스케이프
    [cite_start]escpae_keyword = escape_filter_chars(search_keyword) [cite: 1402]
    
    # 2. 이스케이프된 키워드를 질의문에 사용
    [cite_start]search_str = '(&(objectclass=%s))' % escpae_keyword [cite: 1404]
    conn.search('dc=company.dc=com', search_str, attributes=['sn', 'cn'])
</code></pre>
                    </div>
                </div>
            </div>

            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-mask me-2"></i> 11. 크로스사이트 요청 위조 (CSRF)</h2>
            [cite_start]<p class="text-secondary">웹 응용프로그램이 사용자로부터 받은 요청이 사용자의 의도대로 작성되고 전송된 것인지 확인하지 않아 발생하며, **CSRF 토큰** 검증이 필수입니다[cite: 1441, 1446].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">CSRF 기능 해제</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Django View/Settings) [cite: 1504, 1466]
# settings.py MIDDLEWARE 목록에서 CSRF 항목을 삭제 또는 주석처리 (전역 해제)
# 또는
from django.views.decorators.csrf import csrf_exempt
@csrf_exempt # csrf_exempt 데코레이터로 미들웨어의 CSRF 기능을 해제
def pay_to_point(request):
    # ... (중요 기능 실행)
    return render(request, '/view_wallet.html', {'wallet':ret})
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: CSRF 토큰 활성화</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Django View/Template) [cite: 1485, 1568]
# 1. settings.py MIDDLEWARE 목록에 CSRF 항목을 활성화
[cite_start]MIDDLEWARE = ['django.middleware.csrf.CsrfViewMiddleware', ...] [cite: 1485]

# 2. HTML 템플릿에 CSRF 토큰 명시
# &lt;form action="" method="POST"&gt;
#    [cite_start]{% csrf_token %} &lt;!-- csrf_token 사용 --&gt; [cite: 1568]
#    ...
# &lt;/form&gt;
</code></pre>
                    </div>
                </div>
            </div>

            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-server me-2"></i> 12. 서버사이드 요청 위조 (SSRF)</h2>
            [cite_start]<p class="text-secondary">적절한 검증 절차를 거치지 않은 사용자 입력값을 서버 간 요청에 사용해 악의적인 행위를 발생시킬 수 있습니다[cite: 1657].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">URL 검증 없음</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python requests) [cite: 1682]
def call_third_party_api(request):
    addr = request.POST.get('address', "")
    # 사용자가 입력한 주소를 검증하지 않고 HTTP 요청을 보낸 후 응답을 반환
    result = requests.get(addr).text
    # addr에 내부 IP나 file:// 공격 가능
    return render(request, '/result.html', {'result': result})
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 화이트리스트 URL</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python) [cite: 1713, 1718]
ALLOW_SERVER_LIST = [
    'https://127.0.0.1/latest/',
    'https://192.168.0.1/user_data',
    # ... (허용된 IP/URL 목록)
]
def call_third_party_api(request):
    addr = request.POST.get('address', "")
    
    # 입력한 URL이 화이트리스트에 포함되는지 검증
    [cite_start]if addr not in ALLOW_SERVER_LIST: [cite: 1713]
        return render(request, '/error.html', {'error': '허용되지 않은 서버입니다.'})
        
    [cite_start]result = requests.get(addr).text [cite: 1718]
    return render(request, '/result.html', {'result': result})
</code></pre>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-arrows-split-up-and-left me-2"></i> 13. HTTP 응답분할</h2>
            [cite_start]<p class="text-secondary">HTTP 응답 헤더에 개행문자(`CR`, `LF`)가 포함된 외부 입력값을 사용하여 응답이 분리되고 악의적인 코드가 주입될 수 있습니다[cite: 1749].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">개행문자 검증 없음</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python) [cite: 1774]
def route(request):
    content_type = request.POST.get('content-type')
    res = HttpResponse()
    # 외부 입력값의 개행문자 검증 없이 응답 헤더에 포함
    res['Content-Type'] = content_type
    return res
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 개행문자 제거</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python) [cite: 1786, 1790, 1795]
def route(request):
    content_type = request.POST.get('content-type')
    
    # 응답 헤더에 포함될 수 있는 외부 입력값 내의 개행 문자를 제거
    [cite_start]content_type = content_type.replace('\r', "") [cite: 1786]
    [cite_start]content_type = content_type.replace('\n', "") [cite: 1790]

    res = HttpResponse()
    [cite_start]res['Content-Type'] = content_type [cite: 1795]
    return res
</code></pre>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-calculator me-2"></i> 14. 정수형 오버플로우</h2>
            <p class="text-secondary">정수형 변수가 허용 범위를 넘어서 의도치 않게 작은 수나 음수가 되어 프로그램이 오작동합니다. [cite_start]Python에서는 언어 자체에서 오버플로우가 발생하지 않으나, C언어와 같이 정수형 데이터가 처리되는 패키지 사용 시 유의해야 합니다[cite: 1835, 1836].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">Numpy 사용</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python Numpy) [cite: 1851]
import numpy as np

def handle_data(number, pow):
    # 64비트를 넘어서는 숫자와 지수가 입력될 경우 오버플로우가 발생해 결과값이 0이 된다
    res = np.power(number, pow, dtype=np.int64)
    return res
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 기본 자료형 검사</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python) [cite: 1865, 1871, 1875]
import numpy as np
MAX_NUMBER  = np.iinfo(np.int64).max
MIN_NUMBER  = np.iinfo(np.int64).min

def handle_data_secure(number, pow):
    calculated = number ** pow # 파이썬 기본 자료형으로 계산
    
    # 파이썬 기본 자료형으로 큰 수를 계산한 후 이를 검사해 오버플로우 탐지
    [cite_start]if calculated > MAX_NUMBER or calculated < MIN_NUMBER: [cite: 1871]
        [cite_start]return -1 # 오버플로우 탐지 시 비정상 종료를 나타내는 -1 값 반환 [cite: 1875]
        
    res = np.power(number, pow, dtype=np.int64)
    return res
</code></pre>
                    </div>
                </div>
            </div>

            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-lock-open me-2"></i> 15. 보안기능 결정에 사용되는 부적절한 입력값</h2>
            [cite_start]<p class="text-secondary">인증이나 인가와 같은 보안 결정이 **외부 입력값** (쿠키, 히든 필드)에 기반하여 수행되는 경우 보호 메커니즘을 우회당할 수 있습니다[cite: 1910].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">쿠키 기반 권한</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python Django) [cite: 1931, 1941]
def init_password(request):
    # 쿠키에서 권한 정보를 가져옴 (변조 가능)
    [cite_start]role = request.COOKIES['role'] [cite: 1931]
    
    # 쿠키에서 가져온 권한이 'admin'인지 비교
    [cite_start]if role == 'admin': [cite: 1941]
        # 중요 기능 실행
        password_init_and_sendmail(request_id, request_mail)
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 세션 기반 권한</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python Django) [cite: 1956, 1969]
def init_password(request):
    # 세션에서 권한 정보를 가져옴 (서버에서 관리되어 안전)
    [cite_start]role = request.session['role'] [cite: 1956]
    
    # 세션에서 가져온 권한이 'admin'인지 비교
    [cite_start]if role == 'admin': [cite: 1969]
        # 중요 기능 실행
        password_init_and_sendmail(request_id, request_mail)
</code></pre>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-sd-card me-2"></i> 16. 메모리 버퍼 오버플로우</h2>
            <p class="text-secondary">할당된 메모리 범위를 넘어선 위치에 자료를 읽거나 써서 프로그램 오동작 또는 악의적인 코드 실행 권한을 획득하게 됩니다.</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>C - 취약한 코드</span><span class="badge bg-light text-dark">gets() 사용</span></div>
                        [cite_start]<pre><code class="language-c">/* 취약한 코드 (C) */ [cite: 6067]
void foo() {
    char message[40];
    [cite_start]// gets() 함수는 문자열 길이를 제한 할 수 없어 버퍼 오버플로우 유발 [cite: 6090]
    gets(message); 
} 
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>C - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 안전한 함수 사용</span></div>
                        [cite_start]<pre><code class="language-c">/* 안전한 코드 (C) */ [cite: 7069]
void requestString() {
    char str[100];
    // gets_s() 함수는 문자열 길이 제한이 가능하여 안전
    gets_s(str, sizeof(str));
}
</code></pre>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-danger"><i class="fa-solid fa-square-poll-vertical me-2"></i> 17. 포맷 스트링 삽입</h2>
            [cite_start]<p class="text-secondary">사용자 입력값을 검증 없이 `printf`, `str.format` 등의 포맷 문자열로 사용하여, 메모리 내용 읽기/쓰기 또는 임의 코드 실행을 유발할 수 있습니다[cite: 1993, 1994].</p>
            <div class="row g-4 mb-4 code-container">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-danger"><span>Python - 취약한 코드</span><span class="badge bg-light text-dark">직접 포맷스트링 사용</span></div>
                        [cite_start]<pre><code class="language-python"># 취약한 코드 (Python) [cite: 2022]
def make_user_message(request):
    user_info = get_user_info(request.POST.get('user_id', ''))
    format_string = request.POST.get('msg_format', '')
    
    # 사용자가 입력한 문자열을 포맷 문자열로 사용하고 있어 안전하지 않다
    message = format_string.format(user=user_info)
    # [cite_start]-> format_string에 {user._init_globals_[SECRET_KEY]} 입력 시 내부 정보 노출 [cite: 2003]
</code></pre>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="code-block-header bg-success"><span>Python - 안전한 코드</span><span class="badge bg-light text-dark">Fix: 상수 포맷 사용</span></div>
                        [cite_start]<pre><code class="language-python"># 안전한 코드 (Python) [cite: 2036]
def make_user_message(request):
    user_info = get_user_info(request.POST.get('user_id', ''))
    
    # 1. 포맷 문자열로 상수를 사용
    # [cite_start]2. 사용자 입력값은 포맷 지정자를 이용해 바인딩하여 사용해야 안전하다 [cite: 2023]
    message = 'user name is {0}'.format(user_info.name) 
    
</code></pre>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        Prism.highlightAll();
    });
</script>

</body>
</html>