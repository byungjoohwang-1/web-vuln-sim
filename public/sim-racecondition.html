<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸ˆìœµê¶Œ ê²½ìŸ ì¡°ê±´ ì‹¤ì „ ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .code-font { font-family: 'Courier New', monospace; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .animate-blink { animation: blink 1s infinite; }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-in { animation: slideIn 0.5s ease-out; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-bounce-slow { animation: bounce 2s infinite; }
    </style>
</head>
<body class="bg-gray-900 p-4">

    <!-- íƒ€ì´í‹€ -->
    <div class="max-w-7xl mx-auto mb-4">
        <div class="bg-gradient-to-r from-red-600 to-orange-600 text-white p-4 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-bolt text-3xl"></i>
                    <div>
                        <h1 class="font-bold text-xl">ê¸ˆìœµê¶Œ ê²½ìŸ ì¡°ê±´ (Race Condition) ì‹¤ì „ ì‹œë‚˜ë¦¬ì˜¤</h1>
                        <p class="text-sm">ê°€ì´ë“œ 49 ì œ3ì¥-1: TOCTOU | ìœ„í—˜ë„: 5 (ë§¤ìš° ë†’ìŒ)</p>
                    </div>
                </div>
                <button onclick="resetAll()" class="bg-white text-red-600 px-4 py-2 rounded font-bold hover:bg-gray-100">
                    <i class="fas fa-redo"></i> ì²˜ìŒë¶€í„°
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-4">
        
        <!-- ì¢Œì¸¡: ê³µê²© ì‹œê°í™” -->
        <div class="space-y-4">
            
            <!-- íƒ€ì„ë¼ì¸ -->
            <div class="bg-gray-800 text-white p-4 rounded-lg shadow-lg border-2 border-orange-500">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-clock text-orange-400 text-2xl"></i>
                    <div>
                        <h2 class="font-bold text-lg">â±ï¸ ê²½ìŸ ì¡°ê±´ íƒ€ì„ë¼ì¸</h2>
                        <p class="text-sm text-gray-400" id="timelineStatus">ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
                    </div>
                </div>
                
                <!-- íƒ€ì„ë¼ì¸ ì‹œê°í™” -->
                <div class="bg-black rounded-lg p-4 min-h-[400px]" id="timeline">
                    <div class="text-center text-gray-500 py-20">
                        <i class="fas fa-hourglass-half text-6xl mb-4"></i>
                        <p>Thread ì‹¤í–‰ ìˆœì„œê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <!-- ê³„ì¢Œ ì”ì•¡ ì‹¤ì‹œê°„ -->
            <div class="bg-gray-800 text-white p-4 rounded-lg shadow-lg border-2 border-green-500">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-wallet text-green-400 text-2xl"></i>
                    <h3 class="font-bold">ğŸ’° ê³„ì¢Œ ì”ì•¡ (ì‹¤ì‹œê°„)</h3>
                </div>
                
                <div class="bg-black rounded-lg p-4">
                    <div class="text-center">
                        <p class="text-sm text-gray-400 mb-2">í˜„ì¬ ì”ì•¡</p>
                        <p class="text-4xl font-bold code-font" id="currentBalance">
                            <span class="text-green-400">1,000,000</span>
                            <span class="text-gray-400 text-2xl ml-2">ì›</span>
                        </p>
                        
                        <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-blue-900 p-3 rounded">
                                <p class="text-blue-400 mb-1">Thread 1 ì¶œê¸ˆì•¡</p>
                                <p class="code-font font-bold" id="thread1Amount">-</p>
                            </div>
                            <div class="bg-purple-900 p-3 rounded">
                                <p class="text-purple-400 mb-1">Thread 2 ì¶œê¸ˆì•¡</p>
                                <p class="code-font font-bold" id="thread2Amount">-</p>
                            </div>
                        </div>
                        
                        <div class="mt-3 bg-red-900 p-3 rounded" id="finalBalance" style="display: none;">
                            <p class="text-red-400 mb-1">ìµœì¢… ì”ì•¡</p>
                            <p class="text-2xl font-bold code-font" id="finalBalanceAmount"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ê³µê²© ë‹¨ê³„ -->
            <div class="bg-gray-800 text-white p-4 rounded-lg shadow-lg">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-list-ol text-orange-400"></i>
                    ê³µê²© ì§„í–‰ ë‹¨ê³„
                </h3>
                <div id="attackSteps" class="space-y-2 text-sm max-h-[250px] overflow-auto">
                    <div class="text-gray-500">ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹œì‘í•˜ì„¸ìš”...</div>
                </div>
            </div>

            <!-- ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ -->
            <div class="bg-gray-800 text-white p-4 rounded-lg shadow-lg">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-flask text-orange-400"></i>
                    ì‹¤ì „ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤
                </h3>
                <div class="space-y-2">
                    <button onclick="startScenario(1)" 
                            class="w-full text-left bg-red-900 hover:bg-red-800 px-3 py-2 rounded text-sm transition">
                        <i class="fas fa-money-bill-wave"></i> <strong>ì‹œë‚˜ë¦¬ì˜¤ 1:</strong> ì”ì•¡ ë¶€ì¡± ìš°íšŒ - ë™ì‹œ ì¶œê¸ˆ
                    </button>
                    <button onclick="startScenario(2)" 
                            class="w-full text-left bg-orange-900 hover:bg-orange-800 px-3 py-2 rounded text-sm transition">
                        <i class="fas fa-exchange-alt"></i> <strong>ì‹œë‚˜ë¦¬ì˜¤ 2:</strong> ì¤‘ë³µ ì†¡ê¸ˆ - ë”ë¸”í´ë¦­
                    </button>
                    <button onclick="startScenario(3)" 
                            class="w-full text-left bg-purple-900 hover:bg-purple-800 px-3 py-2 rounded text-sm transition">
                        <i class="fas fa-gift"></i> <strong>ì‹œë‚˜ë¦¬ì˜¤ 3:</strong> í¬ì¸íŠ¸ ì¤‘ë³µ ì‚¬ìš©
                    </button>
                </div>
            </div>

            <!-- ì·¨ì•½í•œ ì½”ë“œ -->
            <div class="bg-gray-900 text-white p-4 rounded-lg shadow-lg border border-red-500">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-red-400">
                        <i class="fas fa-bug"></i> ì·¨ì•½í•œ ì½”ë“œ (Race Condition)
                    </h3>
                    <span class="text-xs bg-red-600 px-2 py-1 rounded">TOCTOU</span>
                </div>
                <pre class="code-font text-xs overflow-x-auto max-h-[700px]"><code><span class="text-gray-500">// Java - ì·¨ì•½í•œ ì¶œê¸ˆ ì½”ë“œ</span>

@Service
public class AccountService {
    
    @Autowired
    private AccountRepository accountRepository;
    
    <span class="text-red-400">// âŒ ë™ê¸°í™” ì—†ìŒ!</span>
    public void withdraw(String accountId, BigDecimal amount) {
        
        Account account = accountRepository.findById(accountId);
        
        <span class="text-red-400">// âŒ TOCTOU: Time of Check</span>
        if (account.getBalance().compareTo(amount) >= 0) {
            
            <span class="text-red-400">// âš ï¸ ì—¬ê¸°ì„œ ë‹¤ë¥¸ Threadê°€ ë¼ì–´ë“¤ ìˆ˜ ìˆìŒ!</span>
            
            <span class="text-red-400">// âŒ TOCTOU: Time of Use</span>
            account.setBalance(
                account.getBalance().subtract(amount)
            );
            
            accountRepository.save(account);
        } else {
            throw new InsufficientFundsException();
        }
    }
}

<span class="text-gray-500">// ê³µê²© ì‹œë‚˜ë¦¬ì˜¤</span>

<span class="text-red-400">// ì´ˆê¸° ì”ì•¡: 1,000,000ì›</span>

<span class="text-cyan-400">Thread 1:</span> withdraw(accountId, 800,000)
  â†’ ì”ì•¡ í™•ì¸: 1,000,000 >= 800,000 âœ“
  
<span class="text-purple-400">Thread 2:</span> withdraw(accountId, 800,000)
  â†’ ì”ì•¡ í™•ì¸: 1,000,000 >= 800,000 âœ“
  
<span class="text-cyan-400">Thread 1:</span> ì”ì•¡ = 1,000,000 - 800,000 = 200,000
  â†’ DB ì €ì¥: 200,000

<span class="text-purple-400">Thread 2:</span> ì”ì•¡ = 1,000,000 - 800,000 = 200,000
  â†’ DB ì €ì¥: 200,000

<span class="text-red-400">// ìµœì¢… ì”ì•¡: 200,000 (ì˜ˆìƒ: -600,000)</span>
<span class="text-red-400">// ì†ì‹¤: 1,400,000ì›!</span>

<span class="text-gray-500">// Python Flask - ì·¨ì•½í•œ ì†¡ê¸ˆ</span>

@app.route('/transfer', methods=['POST'])
def transfer():
    from_account = request.json['from_account']
    amount = request.json['amount']
    
    <span class="text-red-400"># âŒ Lock ì—†ìŒ!</span>
    account = get_account(from_account)
    
    <span class="text-red-400"># TOCTOU: Check</span>
    if account['balance'] >= amount:
        
        <span class="text-red-400"># âš ï¸ ë‹¤ë¥¸ ìš”ì²­ì´ ë¼ì–´ë“¤ ìˆ˜ ìˆìŒ</span>
        
        <span class="text-red-400"># TOCTOU: Use</span>
        new_balance = account['balance'] - amount
        
        update_balance(from_account, new_balance)
        
        return jsonify({"status": "success"})
    else:
        return jsonify({"error": "ì”ì•¡ ë¶€ì¡±"}), 400

<span class="text-gray-500">// Node.js - ì·¨ì•½í•œ í¬ì¸íŠ¸ ì‚¬ìš©</span>

app.post('/use-points', async (req, res) => {
    const { userId, points } = req.body;
    
    <span class="text-red-400">// âŒ ë™ì‹œì„± ì œì–´ ì—†ìŒ</span>
    const user = await User.findById(userId);
    
    <span class="text-red-400">// TOCTOU: Check</span>
    if (user.points >= points) {
        
        <span class="text-red-400">// âš ï¸ Race Condition!</span>
        
        <span class="text-red-400">// TOCTOU: Use</span>
        user.points -= points;
        await user.save();
        
        res.json({ status: 'success' });
    } else {
        res.status(400).json({ error: 'í¬ì¸íŠ¸ ë¶€ì¡±' });
    }
});</code></pre>
            </div>

        </div>

        <!-- ìš°ì¸¡: ì„œë²„ ë¡œê·¸ & ë¶„ì„ -->
        <div class="space-y-4">
            
            <!-- ì„œë²„ ë¡œê·¸ -->
            <div class="bg-gray-800 text-white p-4 rounded-lg shadow-lg border-2 border-blue-500">
                <div class="flex items-center gap-3 mb-3">
                    <i class="fas fa-server text-blue-400 text-2xl"></i>
                    <div>
                        <h2 class="font-bold text-lg">ğŸ”µ ì„œë²„ ì²˜ë¦¬ ë¡œê·¸</h2>
                        <p class="text-sm text-gray-400">ë™ì‹œ ìš”ì²­ ì²˜ë¦¬</p>
                    </div>
                </div>
                
                <!-- ì„œë²„ ë¡œê·¸ -->
                <div class="bg-black rounded-lg p-4 min-h-[450px] max-h-[550px] overflow-auto">
                    <div id="serverLog" class="code-font text-xs space-y-1">
                        <div class="text-gray-500">[SERVER] Waiting...</div>
                    </div>
                </div>
                
                <!-- ìƒíƒœ -->
                <div class="mt-3 flex justify-between items-center">
                    <span class="text-xs text-gray-400">ì„œë²„ ìƒíƒœ:</span>
                    <span id="serverStatus" class="text-xs bg-green-600 px-3 py-1 rounded">RUNNING</span>
                </div>
            </div>

            <!-- ê³µê²© ê²°ê³¼ -->
            <div id="attackResult" class="hidden bg-red-900 text-white p-4 rounded-lg shadow-lg border-2 border-red-500">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-exclamation-circle text-red-400 text-xl animate-pulse"></i>
                    <h3 class="font-bold">ğŸ’¥ ê²½ìŸ ì¡°ê±´ ë°œìƒ!</h3>
                </div>
                <div id="attackResultContent" class="text-sm"></div>
            </div>

            <!-- ë¬¸ì œì  ë¶„ì„ -->
            <div id="problemBox" class="hidden bg-red-900 text-white p-4 rounded-lg shadow-lg">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-exclamation-triangle text-yellow-400 text-xl animate-blink"></i>
                    <h3 class="font-bold">ğŸš¨ ë¬¸ì œì  ë¶„ì„</h3>
                </div>
                <div id="problemContent" class="text-sm space-y-2"></div>
            </div>

            <!-- ì•ˆì „í•œ ì½”ë“œ -->
            <div class="bg-gray-900 text-white p-4 rounded-lg shadow-lg border border-green-500">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-green-400">
                        <i class="fas fa-shield-halved"></i> ì•ˆì „í•œ ì½”ë“œ (ë™ì‹œì„± ì œì–´)
                    </h3>
                    <span class="text-xs bg-green-600 px-2 py-1 rounded">í•´ê²°ì±…</span>
                </div>
                <pre class="code-font text-xs overflow-x-auto max-h-[1100px]"><code><span class="text-gray-500">// Java - ì•ˆì „í•œ ì¶œê¸ˆ (ë°©ë²• 1: synchronized)</span>

@Service
public class SecureAccountService {
    
    @Autowired
    private AccountRepository accountRepository;
    
    <span class="text-green-400">// âœ… synchronized í‚¤ì›Œë“œ</span>
    public synchronized void withdraw(
        String accountId, 
        BigDecimal amount
    ) {
        Account account = accountRepository
            .findById(accountId);
        
        if (account.getBalance().compareTo(amount) >= 0) {
            account.setBalance(
                account.getBalance().subtract(amount)
            );
            accountRepository.save(account);
        } else {
            throw new InsufficientFundsException();
        }
    }
}

<span class="text-gray-500">// ë°©ë²• 2: DB Lock (ê¶Œì¥)</span>

@Service
public class SecureAccountService {
    
    @Autowired
    private AccountRepository accountRepository;
    
    <span class="text-green-400">// âœ… SERIALIZABLE ê²©ë¦¬ ìˆ˜ì¤€</span>
    @Transactional(
        isolation = Isolation.SERIALIZABLE
    )
    public void withdraw(
        String accountId, 
        BigDecimal amount
    ) {
        <span class="text-green-400">// âœ… SELECT FOR UPDATE (ë¹„ê´€ì  ë½)</span>
        Account account = accountRepository
            .findByIdForUpdate(accountId);
        
        if (account.getBalance().compareTo(amount) >= 0) {
            account.setBalance(
                account.getBalance().subtract(amount)
            );
            accountRepository.save(account);
        } else {
            throw new InsufficientFundsException();
        }
    }
}

<span class="text-gray-500">// Repository - SELECT FOR UPDATE</span>

@Repository
public interface AccountRepository 
    extends JpaRepository<Account, String> {
    
    <span class="text-green-400">// âœ… ë¹„ê´€ì  ë½</span>
    @Lock(LockModeType.PESSIMISTIC_WRITE)
    @Query("SELECT a FROM Account a WHERE a.id = :id")
    Account findByIdForUpdate(@Param("id") String id);
}

<span class="text-gray-500">// ë°©ë²• 3: ë‚™ê´€ì  ë½</span>

@Entity
public class Account {
    
    @Id
    private String id;
    
    private BigDecimal balance;
    
    <span class="text-green-400">// âœ… ë²„ì „ í•„ë“œ</span>
    @Version
    private Long version;
    
    // getters/setters
}

@Service
public class OptimisticLockService {
    
    @Transactional
    public void withdraw(
        String accountId, 
        BigDecimal amount
    ) {
        try {
            Account account = accountRepository
                .findById(accountId);
            
            if (account.getBalance().compareTo(amount) >= 0) {
                account.setBalance(
                    account.getBalance().subtract(amount)
                );
                <span class="text-green-400">// ë²„ì „ ë¶ˆì¼ì¹˜ ì‹œ ì˜ˆì™¸ ë°œìƒ</span>
                accountRepository.save(account);
            }
        } catch (OptimisticLockException e) {
            <span class="text-green-400">// âœ… ì¬ì‹œë„</span>
            throw new ConcurrentModificationException(
                "ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”"
            );
        }
    }
}

<span class="text-gray-500">// ë°©ë²• 4: ReentrantLock</span>

@Service
public class LockBasedService {
    
    <span class="text-green-400">// âœ… ê³„ì¢Œë³„ Lock Map</span>
    private final ConcurrentHashMap<String, ReentrantLock> 
        locks = new ConcurrentHashMap<>();
    
    public void withdraw(
        String accountId, 
        BigDecimal amount
    ) {
        <span class="text-green-400">// ê³„ì¢Œë³„ Lock íšë“</span>
        ReentrantLock lock = locks.computeIfAbsent(
            accountId, 
            k -> new ReentrantLock()
        );
        
        lock.lock();
        try {
            Account account = accountRepository
                .findById(accountId);
            
            if (account.getBalance().compareTo(amount) >= 0) {
                account.setBalance(
                    account.getBalance().subtract(amount)
                );
                accountRepository.save(account);
            } else {
                throw new InsufficientFundsException();
            }
        } finally {
            <span class="text-green-400">// âœ… ë°˜ë“œì‹œ unlock</span>
            lock.unlock();
        }
    }
}

<span class="text-gray-500">// Python Flask - ì•ˆì „í•œ ì†¡ê¸ˆ</span>

from threading import Lock
from flask import Flask, request, jsonify

<span class="text-green-400"># âœ… ê³„ì¢Œë³„ Lock ë”•ì…”ë„ˆë¦¬</span>
account_locks = {}

def get_lock(account_id):
    if account_id not in account_locks:
        account_locks[account_id] = Lock()
    return account_locks[account_id]

@app.route('/transfer', methods=['POST'])
def transfer():
    from_account = request.json['from_account']
    amount = request.json['amount']
    
    <span class="text-green-400"># âœ… Lock íšë“</span>
    lock = get_lock(from_account)
    
    with lock:
        account = get_account(from_account)
        
        if account['balance'] >= amount:
            new_balance = account['balance'] - amount
            update_balance(from_account, new_balance)
            
            return jsonify({"status": "success"})
        else:
            return jsonify({"error": "ì”ì•¡ ë¶€ì¡±"}), 400

<span class="text-gray-500"># Django - íŠ¸ëœì­ì…˜ + SELECT FOR UPDATE</span>

from django.db import transaction
from django.db.models import F

@transaction.atomic
def secure_withdraw(account_id, amount):
    
    <span class="text-green-400"># âœ… SELECT FOR UPDATE</span>
    account = Account.objects.select_for_update().get(
        id=account_id
    )
    
    if account.balance >= amount:
        <span class="text-green-400"># âœ… F() ê°ì²´ë¡œ ì›ìì  ì—°ì‚°</span>
        account.balance = F('balance') - amount
        account.save()
        
        <span class="text-green-400"># refreshë¡œ ìµœì‹  ê°’ ê°€ì ¸ì˜¤ê¸°</span>
        account.refresh_from_db()
        
        return account
    else:
        raise ValueError("ì”ì•¡ ë¶€ì¡±")

<span class="text-gray-500">// Node.js - Sequelize Lock</span>

const { Sequelize, Op } = require('sequelize');

app.post('/use-points', async (req, res) => {
    const { userId, points } = req.body;
    
    <span class="text-green-400">// âœ… íŠ¸ëœì­ì…˜ + Lock</span>
    const t = await sequelize.transaction({
        isolationLevel: 
            Sequelize.Transaction.ISOLATION_LEVELS
                .SERIALIZABLE
    });
    
    try {
        <span class="text-green-400">// âœ… FOR UPDATE ë½</span>
        const user = await User.findByPk(userId, {
            lock: t.LOCK.UPDATE,
            transaction: t
        });
        
        if (user.points >= points) {
            user.points -= points;
            await user.save({ transaction: t });
            
            await t.commit();
            res.json({ status: 'success' });
        } else {
            await t.rollback();
            res.status(400).json({ error: 'í¬ì¸íŠ¸ ë¶€ì¡±' });
        }
    } catch (error) {
        await t.rollback();
        res.status(500).json({ error: error.message });
    }
});

<span class="text-gray-500">// MongoDB - Optimistic Locking</span>

const pointSchema = new Schema({
    userId: String,
    points: Number,
    <span class="text-green-400">// âœ… ë²„ì „ í•„ë“œ</span>
    __v: { type: Number, default: 0 }
});

async function usePoints(userId, points) {
    const maxRetries = 3;
    
    for (let i = 0; i < maxRetries; i++) {
        const user = await User.findOne({ userId });
        
        if (user.points >= points) {
            <span class="text-green-400">// âœ… ë²„ì „ ì²´í¬ ì—…ë°ì´íŠ¸</span>
            const result = await User.updateOne(
                { 
                    userId: userId, 
                    __v: user.__v  // ë²„ì „ í™•ì¸
                },
                { 
                    $inc: { 
                        points: -points,
                        __v: 1  // ë²„ì „ ì¦ê°€
                    }
                }
            );
            
            if (result.modifiedCount > 0) {
                return { status: 'success' };
            }
            <span class="text-green-400">// ë²„ì „ ë¶ˆì¼ì¹˜ -> ì¬ì‹œë„</span>
        } else {
            throw new Error('í¬ì¸íŠ¸ ë¶€ì¡±');
        }
    }
    
    throw new Error('ë™ì‹œì„± ì¶©ëŒ, ì¬ì‹œë„ ì´ˆê³¼');
}

<span class="text-gray-500">// Redis - ë¶„ì‚° ë½</span>

const Redis = require('ioredis');
const redis = new Redis();

async function withdrawWithRedisLock(accountId, amount) {
    const lockKey = `lock:account:${accountId}`;
    const lockValue = Date.now() + 10000; // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
    
    <span class="text-green-400">// âœ… ë¶„ì‚° ë½ íšë“ ì‹œë„</span>
    const acquired = await redis.set(
        lockKey, 
        lockValue, 
        'PX', 10000,  // 10ì´ˆ í›„ ìë™ ë§Œë£Œ
        'NX'          // ì—†ì„ ë•Œë§Œ ì„¤ì •
    );
    
    if (!acquired) {
        throw new Error('ë‹¤ë¥¸ ì²˜ë¦¬ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤');
    }
    
    try {
        <span class="text-green-400">// ì¶œê¸ˆ ì²˜ë¦¬</span>
        const account = await getAccount(accountId);
        
        if (account.balance >= amount) {
            account.balance -= amount;
            await saveAccount(account);
            return { status: 'success' };
        } else {
            throw new Error('ì”ì•¡ ë¶€ì¡±');
        }
    } finally {
        <span class="text-green-400">// âœ… ë½ í•´ì œ</span>
        await redis.del(lockKey);
    }
}</code></pre>
            </div>

        </div>
    </div>

    <script>
        let isRunning = false;
        let currentBalance = 1000000;

        function resetAll() {
            isRunning = false;
            currentBalance = 1000000;
            
            document.getElementById('timelineStatus').textContent = 'ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹œì‘í•˜ì„¸ìš”';
            
            document.getElementById('timeline').innerHTML = 
                '<div class="text-center text-gray-500 py-20">' +
                '<i class="fas fa-hourglass-half text-6xl mb-4"></i>' +
                '<p>Thread ì‹¤í–‰ ìˆœì„œê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤</p>' +
                '</div>';
            
            document.getElementById('currentBalance').innerHTML = 
                '<span class="text-green-400">1,000,000</span>' +
                '<span class="text-gray-400 text-2xl ml-2">ì›</span>';
            
            document.getElementById('thread1Amount').textContent = '-';
            document.getElementById('thread2Amount').textContent = '-';
            document.getElementById('finalBalance').style.display = 'none';
            
            document.getElementById('serverLog').innerHTML = 
                '<div class="text-gray-500">[SERVER] Waiting...</div>';
            
            document.getElementById('serverStatus').textContent = 'RUNNING';
            document.getElementById('serverStatus').className = 'text-xs bg-green-600 px-3 py-1 rounded';
            
            document.getElementById('attackSteps').innerHTML = 
                '<div class="text-gray-500">ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹œì‘í•˜ì„¸ìš”...</div>';
            
            document.getElementById('attackResult').classList.add('hidden');
            document.getElementById('problemBox').classList.add('hidden');
        }

        async function startScenario(scenario) {
            if (isRunning) return;
            isRunning = true;
            
            resetAll();
            await sleep(300);
            
            if (scenario === 1) {
                await scenario1_ConcurrentWithdraw();
            } else if (scenario === 2) {
                await scenario2_DoubleClick();
            } else if (scenario === 3) {
                await scenario3_PointDuplication();
            }
            
            isRunning = false;
        }

        // ì‹œë‚˜ë¦¬ì˜¤ 1: ì”ì•¡ ë¶€ì¡± ìš°íšŒ - ë™ì‹œ ì¶œê¸ˆ
        async function scenario1_ConcurrentWithdraw() {
            updateStep('ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ 1: ê²½ìŸ ì¡°ê±´ - ì”ì•¡ ë¶€ì¡± ìš°íšŒ');
            await sleep(1000);
            
            currentBalance = 1000000;
            updateBalance(1000000);
            
            updateStep('1ï¸âƒ£ ì´ˆê¸° ìƒíƒœ: ì”ì•¡ 1,000,000ì›');
            document.getElementById('timelineStatus').textContent = 'ë™ì‹œ ì¶œê¸ˆ ê³µê²© ì‹œì‘...';
            
            await addServerLog('[INFO] Account balance: 1,000,000ì›', 'text-green-400');
            await sleep(500);
            await addServerLog('[INFO] Withdrawal service ready', 'text-blue-400');
            await sleep(1000);
            
            updateStep('2ï¸âƒ£ Thread 1ê³¼ Thread 2ê°€ ë™ì‹œì— 800,000ì› ì¶œê¸ˆ ìš”ì²­');
            
            document.getElementById('thread1Amount').textContent = '800,000ì›';
            document.getElementById('thread2Amount').textContent = '800,000ì›';
            
            // íƒ€ì„ë¼ì¸ ì´ˆê¸°í™”
            let timelineHTML = '<div class="space-y-2">';
            
            // Thread 1 ì‹œì‘
            await addServerLog('');
            await addServerLog('[Thread-1] ì¶œê¸ˆ ìš”ì²­: 800,000ì›', 'text-cyan-400');
            await sleep(300);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-cyan-400 text-xs">Thread 1</div>' +
                '<div class="flex-1 bg-cyan-900 p-2 rounded text-xs">' +
                '<i class="fas fa-play mr-2"></i>ì¶œê¸ˆ ì‹œì‘: 800,000ì›' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(500);
            
            // Thread 2 ì‹œì‘
            await addServerLog('[Thread-2] ì¶œê¸ˆ ìš”ì²­: 800,000ì›', 'text-purple-400');
            await sleep(300);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-purple-400 text-xs">Thread 2</div>' +
                '<div class="flex-1 bg-purple-900 p-2 rounded text-xs">' +
                '<i class="fas fa-play mr-2"></i>ì¶œê¸ˆ ì‹œì‘: 800,000ì›' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(800);
            
            updateStep('3ï¸âƒ£ <span class="text-yellow-500 font-bold">TOCTOU: Time of Check (ì”ì•¡ í™•ì¸)</span>');
            
            // Thread 1 ì”ì•¡ í™•ì¸
            await addServerLog('[Thread-1] SELECT balance FROM accounts', 'text-cyan-400');
            await sleep(300);
            await addServerLog('[Thread-1] ì”ì•¡: 1,000,000 >= 800,000 âœ“', 'text-green-400');
            await sleep(500);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-cyan-400 text-xs">Thread 1</div>' +
                '<div class="flex-1 bg-green-900 p-2 rounded text-xs">' +
                '<i class="fas fa-check mr-2"></i>ì”ì•¡ í™•ì¸: 1,000,000ì› â‰¥ 800,000ì› âœ“' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(500);
            
            // Thread 2 ì”ì•¡ í™•ì¸
            await addServerLog('[Thread-2] SELECT balance FROM accounts', 'text-purple-400');
            await sleep(300);
            await addServerLog('[Thread-2] ì”ì•¡: 1,000,000 >= 800,000 âœ“', 'text-green-400');
            await sleep(500);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-purple-400 text-xs">Thread 2</div>' +
                '<div class="flex-1 bg-green-900 p-2 rounded text-xs">' +
                '<i class="fas fa-check mr-2"></i>ì”ì•¡ í™•ì¸: 1,000,000ì› â‰¥ 800,000ì› âœ“' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(1000);
            
            updateStep('4ï¸âƒ£ <span class="text-orange-500">âš ï¸ ê²½ìŸ ì¡°ê±´ êµ¬ê°„ (Race Window)</span>');
            
            timelineHTML += 
                '<div class="bg-red-900 p-3 rounded my-2 animate-pulse">' +
                '<div class="text-red-400 font-bold text-center">' +
                '<i class="fas fa-exclamation-triangle mr-2"></i>' +
                'âš ï¸ RACE CONDITION WINDOW âš ï¸' +
                '</div>' +
                '<div class="text-xs text-gray-300 text-center mt-1">' +
                'ë‘ Thread ëª¨ë‘ ì”ì•¡ì´ ì¶©ë¶„í•˜ë‹¤ê³  íŒë‹¨!' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(1500);
            
            updateStep('5ï¸âƒ£ <span class="text-red-500 font-bold">TOCTOU: Time of Use (ì¶œê¸ˆ ì‹¤í–‰)</span>');
            
            // Thread 1 ì¶œê¸ˆ
            await addServerLog('[Thread-1] ì¶œê¸ˆ ì‹¤í–‰...', 'text-cyan-400');
            await sleep(300);
            await addServerLog('[Thread-1] ìƒˆ ì”ì•¡ = 1,000,000 - 800,000', 'text-yellow-400');
            await sleep(300);
            await addServerLog('[Thread-1] UPDATE balance = 200,000', 'text-cyan-400');
            await sleep(500);
            
            updateBalance(200000);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-cyan-400 text-xs">Thread 1</div>' +
                '<div class="flex-1 bg-yellow-900 p-2 rounded text-xs">' +
                '<i class="fas fa-minus mr-2"></i>ì¶œê¸ˆ ì‹¤í–‰: 1,000,000 - 800,000 = 200,000ì›' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(800);
            
            // Thread 2 ì¶œê¸ˆ
            await addServerLog('[Thread-2] ì¶œê¸ˆ ì‹¤í–‰...', 'text-purple-400');
            await sleep(300);
            await addServerLog('[Thread-2] ìƒˆ ì”ì•¡ = 1,000,000 - 800,000', 'text-yellow-400');
            await sleep(300);
            await addServerLog('[Thread-2] UPDATE balance = 200,000', 'text-red-400');
            await sleep(500);
            
            updateBalance(200000);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-purple-400 text-xs">Thread 2</div>' +
                '<div class="flex-1 bg-red-900 p-2 rounded text-xs">' +
                '<i class="fas fa-minus mr-2"></i>ì¶œê¸ˆ ì‹¤í–‰: 1,000,000 - 800,000 = 200,000ì›' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(1000);
            
            updateStep('6ï¸âƒ£ <span class="text-red-500 font-bold">ğŸ’¥ ìµœì¢… ì”ì•¡: 200,000ì› (ì˜ˆìƒ: -600,000ì›)</span>');
            
            document.getElementById('finalBalance').style.display = 'block';
            document.getElementById('finalBalanceAmount').innerHTML = 
                '<span class="text-red-400">200,000ì›</span>' +
                '<div class="text-xs text-gray-300 mt-1">(ì˜ˆìƒ: -600,000ì›)</div>' +
                '<div class="text-xs text-yellow-300">ì†ì‹¤: 1,400,000ì›!</div>';
            
            await addServerLog('');
            await addServerLog('[RESULT] ìµœì¢… ì”ì•¡: 200,000ì›', 'text-red-400');
            await sleep(300);
            await addServerLog('[ERROR] ê²½ìŸ ì¡°ê±´ ë°œìƒ!', 'text-red-400');
            await sleep(300);
            await addServerLog('[ALERT] ì˜ˆìƒ ì†ì‹¤: 1,400,000ì›', 'text-red-400');
            
            timelineHTML += 
                '<div class="bg-red-900 p-4 rounded mt-3 border-2 border-red-500">' +
                '<div class="text-red-400 font-bold text-center mb-2">' +
                '<i class="fas fa-skull-crossbones mr-2"></i>ê²½ìŸ ì¡°ê±´ ë°œìƒ!' +
                '</div>' +
                '<div class="grid grid-cols-2 gap-2 text-xs">' +
                '<div class="bg-black p-2 rounded">' +
                '<div class="text-gray-400">ìµœì¢… ì”ì•¡</div>' +
                '<div class="text-red-400 font-bold">200,000ì›</div>' +
                '</div>' +
                '<div class="bg-black p-2 rounded">' +
                '<div class="text-gray-400">ì˜ˆìƒ ì”ì•¡</div>' +
                '<div class="text-yellow-400 font-bold">-600,000ì›</div>' +
                '</div>' +
                '</div>' +
                '<div class="text-center mt-2 text-yellow-400 font-bold">' +
                'ğŸ’° ì†ì‹¤: 1,400,000ì›!' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            document.getElementById('attackResult').classList.remove('hidden');
            document.getElementById('attackResultContent').innerHTML = 
                '<div class="bg-black bg-opacity-30 p-3 rounded">' +
                '<p class="font-bold mb-2">ğŸ’° ì¬ë¬´ ì†ì‹¤:</p>' +
                '<div class="grid grid-cols-2 gap-2 text-sm">' +
                '<div class="bg-red-800 p-2 rounded">' +
                '<div class="text-gray-300">ì´ ì¶œê¸ˆì•¡</div>' +
                '<div class="font-bold">1,600,000ì›</div>' +
                '</div>' +
                '<div class="bg-red-800 p-2 rounded">' +
                '<div class="text-gray-300">ì‹¤ì œ ì°¨ê°</div>' +
                '<div class="font-bold">800,000ì›</div>' +
                '</div>' +
                '</div>' +
                '<div class="mt-2 text-yellow-400 font-bold text-center">' +
                'ì†ì‹¤: 800,000ì› (50%)' +
                '</div>' +
                '</div>';
            
            showResults('scenario1');
        }

        // ì‹œë‚˜ë¦¬ì˜¤ 2: ì¤‘ë³µ ì†¡ê¸ˆ
        async function scenario2_DoubleClick() {
            updateStep('ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ 2: ì¤‘ë³µ ì†¡ê¸ˆ - ë”ë¸”í´ë¦­ ê³µê²©');
            await sleep(1000);
            
            currentBalance = 1000000;
            updateBalance(1000000);
            
            updateStep('1ï¸âƒ£ ì†¡ê¸ˆ í˜ì´ì§€ì—ì„œ 500,000ì› ì†¡ê¸ˆ ì‹œë„');
            document.getElementById('timelineStatus').textContent = 'ì†¡ê¸ˆ ë²„íŠ¼ ë”ë¸”í´ë¦­...';
            
            await addServerLog('[INFO] Transfer page loaded', 'text-blue-400');
            await sleep(500);
            await addServerLog('[INFO] From: 110-123-456789', 'text-gray-400');
            await sleep(300);
            await addServerLog('[INFO] To: 110-987-654321', 'text-gray-400');
            await sleep(300);
            await addServerLog('[INFO] Amount: 500,000ì›', 'text-gray-400');
            await sleep(1000);
            
            updateStep('2ï¸âƒ£ <span class="text-orange-500">ì†¡ê¸ˆ ë²„íŠ¼ì„ ë¹ ë¥´ê²Œ 2ë²ˆ í´ë¦­ (ë”ë¸”í´ë¦­)</span>');
            
            document.getElementById('thread1Amount').textContent = '500,000ì›';
            document.getElementById('thread2Amount').textContent = '500,000ì›';
            
            let timelineHTML = '<div class="space-y-2">';
            
            await addServerLog('');
            await addServerLog('[Request-1] POST /transfer', 'text-cyan-400');
            await sleep(200);
            await addServerLog('[Request-2] POST /transfer', 'text-purple-400');
            await sleep(500);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-cyan-400 text-xs">Request 1</div>' +
                '<div class="flex-1 bg-cyan-900 p-2 rounded text-xs">' +
                'ì†¡ê¸ˆ ìš”ì²­: 500,000ì›' +
                '</div>' +
                '</div>' +
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-purple-400 text-xs">Request 2</div>' +
                '<div class="flex-1 bg-purple-900 p-2 rounded text-xs">' +
                'ì†¡ê¸ˆ ìš”ì²­: 500,000ì› (0.05ì´ˆ í›„)' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(1000);
            
            updateStep('3ï¸âƒ£ ë‘ ìš”ì²­ì´ ë™ì‹œì— ì”ì•¡ í™•ì¸');
            
            await addServerLog('[Request-1] ì”ì•¡ í™•ì¸: 1,000,000ì›', 'text-cyan-400');
            await sleep(300);
            await addServerLog('[Request-2] ì”ì•¡ í™•ì¸: 1,000,000ì›', 'text-purple-400');
            await sleep(500);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-cyan-400 text-xs">Request 1</div>' +
                '<div class="flex-1 bg-green-900 p-2 rounded text-xs">' +
                'âœ“ ì”ì•¡ ì¶©ë¶„: 1,000,000ì› â‰¥ 500,000ì›' +
                '</div>' +
                '</div>' +
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-purple-400 text-xs">Request 2</div>' +
                '<div class="flex-1 bg-green-900 p-2 rounded text-xs">' +
                'âœ“ ì”ì•¡ ì¶©ë¶„: 1,000,000ì› â‰¥ 500,000ì›' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(1000);
            
            updateStep('4ï¸âƒ£ <span class="text-red-500 font-bold">ì†¡ê¸ˆ 2ë²ˆ ì‹¤í–‰!</span>');
            
            await addServerLog('[Request-1] ì†¡ê¸ˆ ì‹¤í–‰...', 'text-cyan-400');
            await sleep(300);
            await addServerLog('[Request-1] ì”ì•¡ = 1,000,000 - 500,000', 'text-yellow-400');
            await sleep(300);
            
            updateBalance(500000);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-cyan-400 text-xs">Request 1</div>' +
                '<div class="flex-1 bg-yellow-900 p-2 rounded text-xs">' +
                'ì†¡ê¸ˆ ì™„ë£Œ: ì”ì•¡ 500,000ì›' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(500);
            
            await addServerLog('[Request-2] ì†¡ê¸ˆ ì‹¤í–‰...', 'text-purple-400');
            await sleep(300);
            await addServerLog('[Request-2] ì”ì•¡ = 1,000,000 - 500,000', 'text-yellow-400');
            await sleep(300);
            
            updateBalance(500000);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-purple-400 text-xs">Request 2</div>' +
                '<div class="flex-1 bg-red-900 p-2 rounded text-xs">' +
                'ì†¡ê¸ˆ ì™„ë£Œ: ì”ì•¡ 500,000ì› (ì¤‘ë³µ!)' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(1000);
            
            updateStep('5ï¸âƒ£ <span class="text-red-500 font-bold">ğŸ’¥ 500,000ì› 2ë²ˆ ì†¡ê¸ˆ = 1,000,000ì› ì†ì‹¤!</span>');
            
            document.getElementById('finalBalance').style.display = 'block';
            document.getElementById('finalBalanceAmount').innerHTML = 
                '<span class="text-red-400">500,000ì›</span>' +
                '<div class="text-xs text-gray-300 mt-1">(ì˜ˆìƒ: 500,000ì›)</div>' +
                '<div class="text-xs text-yellow-300">ì¤‘ë³µ ì†¡ê¸ˆ: 1,000,000ì›!</div>';
            
            await addServerLog('');
            await addServerLog('[RESULT] ì´ ì†¡ê¸ˆì•¡: 1,000,000ì›', 'text-red-400');
            await sleep(300);
            await addServerLog('[ERROR] ì¤‘ë³µ ì†¡ê¸ˆ ë°œìƒ!', 'text-red-400');
            
            timelineHTML += 
                '<div class="bg-red-900 p-4 rounded mt-3 border-2 border-red-500">' +
                '<div class="text-red-400 font-bold text-center mb-2">' +
                'ğŸ’¸ ì¤‘ë³µ ì†¡ê¸ˆ ë°œìƒ!' +
                '</div>' +
                '<div class="text-xs text-center text-gray-300">' +
                '500,000ì› Ã— 2íšŒ = 1,000,000ì› ì†¡ê¸ˆ' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            document.getElementById('attackResult').classList.remove('hidden');
            document.getElementById('attackResultContent').innerHTML = 
                '<div class="bg-black bg-opacity-30 p-3 rounded">' +
                '<p class="font-bold mb-2">ğŸ’¸ ì¤‘ë³µ ì†¡ê¸ˆ:</p>' +
                '<div class="space-y-1 text-sm">' +
                '<div>â€¢ ì˜ë„í•œ ì†¡ê¸ˆ: 500,000ì› Ã— 1íšŒ</div>' +
                '<div>â€¢ ì‹¤ì œ ì†¡ê¸ˆ: 500,000ì› Ã— 2íšŒ</div>' +
                '<div class="text-red-400 font-bold">â€¢ ì¶”ê°€ ì†ì‹¤: 500,000ì›</div>' +
                '</div>' +
                '</div>';
            
            showResults('scenario2');
        }

        // ì‹œë‚˜ë¦¬ì˜¤ 3: í¬ì¸íŠ¸ ì¤‘ë³µ ì‚¬ìš©
        async function scenario3_PointDuplication() {
            updateStep('ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ 3: í¬ì¸íŠ¸ ì¤‘ë³µ ì‚¬ìš© - ë™ì‹œ ê²°ì œ');
            await sleep(1000);
            
            currentBalance = 50000; // í¬ì¸íŠ¸
            updateBalance(50000);
            
            document.getElementById('currentBalance').innerHTML = 
                '<span class="text-green-400">50,000</span>' +
                '<span class="text-gray-400 text-2xl ml-2">P</span>';
            
            updateStep('1ï¸âƒ£ ë³´ìœ  í¬ì¸íŠ¸: 50,000P');
            document.getElementById('timelineStatus').textContent = 'í¬ì¸íŠ¸ ì¤‘ë³µ ì‚¬ìš© ì‹œë„...';
            
            await addServerLog('[INFO] User points: 50,000P', 'text-green-400');
            await sleep(1000);
            
            updateStep('2ï¸âƒ£ 2ê°œ íƒ­ì—ì„œ ë™ì‹œì— ê°ê° 40,000P ì‚¬ìš© ì‹œë„');
            
            document.getElementById('thread1Amount').textContent = '40,000P';
            document.getElementById('thread2Amount').textContent = '40,000P';
            
            let timelineHTML = '<div class="space-y-2">';
            
            await addServerLog('');
            await addServerLog('[Tab-1] 40,000P ì‚¬ìš© ìš”ì²­', 'text-cyan-400');
            await sleep(200);
            await addServerLog('[Tab-2] 40,000P ì‚¬ìš© ìš”ì²­', 'text-purple-400');
            await sleep(500);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-cyan-400 text-xs">Tab 1</div>' +
                '<div class="flex-1 bg-cyan-900 p-2 rounded text-xs">' +
                'í¬ì¸íŠ¸ ì‚¬ìš©: 40,000P' +
                '</div>' +
                '</div>' +
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-purple-400 text-xs">Tab 2</div>' +
                '<div class="flex-1 bg-purple-900 p-2 rounded text-xs">' +
                'í¬ì¸íŠ¸ ì‚¬ìš©: 40,000P' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(1000);
            
            updateStep('3ï¸âƒ£ ë‘ ìš”ì²­ ëª¨ë‘ í¬ì¸íŠ¸ ì¶©ë¶„ í™•ì¸');
            
            await addServerLog('[Tab-1] í¬ì¸íŠ¸ í™•ì¸: 50,000P >= 40,000P âœ“', 'text-cyan-400');
            await sleep(300);
            await addServerLog('[Tab-2] í¬ì¸íŠ¸ í™•ì¸: 50,000P >= 40,000P âœ“', 'text-purple-400');
            await sleep(500);
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-cyan-400 text-xs">Tab 1</div>' +
                '<div class="flex-1 bg-green-900 p-2 rounded text-xs">' +
                'âœ“ í¬ì¸íŠ¸ ì¶©ë¶„: 50,000P â‰¥ 40,000P' +
                '</div>' +
                '</div>' +
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-purple-400 text-xs">Tab 2</div>' +
                '<div class="flex-1 bg-green-900 p-2 rounded text-xs">' +
                'âœ“ í¬ì¸íŠ¸ ì¶©ë¶„: 50,000P â‰¥ 40,000P' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(1000);
            
            updateStep('4ï¸âƒ£ <span class="text-red-500 font-bold">í¬ì¸íŠ¸ 2ë²ˆ ì°¨ê°!</span>');
            
            await addServerLog('[Tab-1] ì°¨ê°: 50,000 - 40,000 = 10,000P', 'text-cyan-400');
            await sleep(500);
            
            currentBalance = 10000;
            document.getElementById('currentBalance').innerHTML = 
                '<span class="text-yellow-400">10,000</span>' +
                '<span class="text-gray-400 text-2xl ml-2">P</span>';
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-cyan-400 text-xs">Tab 1</div>' +
                '<div class="flex-1 bg-yellow-900 p-2 rounded text-xs">' +
                'ì°¨ê° ì™„ë£Œ: 50,000 - 40,000 = 10,000P' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(500);
            
            await addServerLog('[Tab-2] ì°¨ê°: 50,000 - 40,000 = 10,000P', 'text-purple-400');
            await sleep(500);
            
            currentBalance = 10000;
            document.getElementById('currentBalance').innerHTML = 
                '<span class="text-red-400">10,000</span>' +
                '<span class="text-gray-400 text-2xl ml-2">P</span>';
            
            timelineHTML += 
                '<div class="flex items-center gap-2 slide-in">' +
                '<div class="w-24 text-purple-400 text-xs">Tab 2</div>' +
                '<div class="flex-1 bg-red-900 p-2 rounded text-xs">' +
                'ì°¨ê° ì™„ë£Œ: 50,000 - 40,000 = 10,000P (ì¤‘ë³µ!)' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            await sleep(1000);
            
            updateStep('5ï¸âƒ£ <span class="text-red-500 font-bold">ğŸ’¥ 40,000P 2ë²ˆ ì‚¬ìš© (80,000P í˜œíƒ)</span>');
            
            document.getElementById('finalBalance').style.display = 'block';
            document.getElementById('finalBalanceAmount').innerHTML = 
                '<span class="text-red-400">10,000P</span>' +
                '<div class="text-xs text-gray-300 mt-1">(ì˜ˆìƒ: -30,000P)</div>' +
                '<div class="text-xs text-yellow-300">ë¶€ì • ì‚¬ìš©: 40,000P!</div>';
            
            await addServerLog('');
            await addServerLog('[RESULT] ìµœì¢… í¬ì¸íŠ¸: 10,000P', 'text-red-400');
            await sleep(300);
            await addServerLog('[ERROR] ì¤‘ë³µ ì‚¬ìš© ë°œìƒ!', 'text-red-400');
            await sleep(300);
            await addServerLog('[ALERT] ë¶€ì • ì‚¬ìš©: 40,000P', 'text-red-400');
            
            timelineHTML += 
                '<div class="bg-red-900 p-4 rounded mt-3 border-2 border-red-500">' +
                '<div class="text-red-400 font-bold text-center mb-2">' +
                'ğŸ í¬ì¸íŠ¸ ì¤‘ë³µ ì‚¬ìš©!' +
                '</div>' +
                '<div class="grid grid-cols-2 gap-2 text-xs">' +
                '<div class="bg-black p-2 rounded">' +
                '<div class="text-gray-400">ì´ ì‚¬ìš©</div>' +
                '<div class="text-red-400 font-bold">80,000P</div>' +
                '</div>' +
                '<div class="bg-black p-2 rounded">' +
                '<div class="text-gray-400">ì‹¤ì œ ì°¨ê°</div>' +
                '<div class="text-yellow-400 font-bold">40,000P</div>' +
                '</div>' +
                '</div>' +
                '<div class="text-center mt-2 text-yellow-400 font-bold">' +
                'ë¶€ì • ì‚¬ìš©: 40,000P' +
                '</div>' +
                '</div>';
            document.getElementById('timeline').innerHTML = timelineHTML;
            
            document.getElementById('attackResult').classList.remove('hidden');
            document.getElementById('attackResultContent').innerHTML = 
                '<div class="bg-black bg-opacity-30 p-3 rounded">' +
                '<p class="font-bold mb-2">ğŸ í¬ì¸íŠ¸ ë¶€ì • ì‚¬ìš©:</p>' +
                '<div class="space-y-1 text-sm">' +
                '<div>â€¢ ì´ ì‚¬ìš©: 80,000P (40,000 Ã— 2)</div>' +
                '<div>â€¢ ì‹¤ì œ ì°¨ê°: 40,000P</div>' +
                '<div class="text-red-400 font-bold">â€¢ ë¶€ì • í˜œíƒ: 40,000P</div>' +
                '</div>' +
                '</div>';
            
            showResults('scenario3');
        }

        function showResults(scenario) {
            document.getElementById('problemBox').classList.remove('hidden');
            
            let problems = '';
            if (scenario === 'scenario1') {
                problems = 
                    '<div class="bg-black bg-opacity-30 p-3 rounded">' +
                    '<p class="font-bold mb-2">âŒ ê²½ìŸ ì¡°ê±´ ë¬¸ì œ:</p>' +
                    '<div class="space-y-1 ml-4 text-xs">' +
                    '<div>1. Checkì™€ Use ì‚¬ì´ ì‹œê°„ì°¨ ì¡´ì¬</div>' +
                    '<div>2. ë™ê¸°í™” ë©”ì»¤ë‹ˆì¦˜ ì—†ìŒ</div>' +
                    '<div>3. DB Lock ë¯¸ì‚¬ìš©</div>' +
                    '<div>4. ë‘ Threadê°€ ê°™ì€ ê°’ ì½ìŒ</div>' +
                    '</div></div>' +
                    '<div class="bg-black bg-opacity-30 p-3 rounded mt-2">' +
                    '<p class="font-bold mb-2">ğŸ’¥ ì˜ˆìƒ í”¼í•´:</p>' +
                    '<div class="space-y-1 ml-4 text-xs">' +
                    '<div>â€¢ ì”ì•¡ ë¶€ì¡± ìš°íšŒ</div>' +
                    '<div>â€¢ ë§ˆì´ë„ˆìŠ¤ í†µì¥ ë°œìƒ</div>' +
                    '<div>â€¢ ì€í–‰ ì†ì‹¤: 1,400,000ì›</div>' +
                    '<div>â€¢ ëŒ€ëŸ‰ ë°œìƒ ì‹œ íŒŒì‚° ìœ„í—˜</div>' +
                    '</div></div>';
            } else if (scenario === 'scenario2') {
                problems = 
                    '<div class="bg-black bg-opacity-30 p-3 rounded">' +
                    '<p class="font-bold mb-2">âŒ ì¤‘ë³µ ì†¡ê¸ˆ ë¬¸ì œ:</p>' +
                    '<div class="space-y-1 ml-4 text-xs">' +
                    '<div>1. ë²„íŠ¼ ì¤‘ë³µ í´ë¦­ ë°©ì§€ ì—†ìŒ</div>' +
                    '<div>2. ìš”ì²­ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ ì—†ìŒ</div>' +
                    '<div>3. ë©±ë“±ì„±(Idempotency) ë¯¸ë³´ì¥</div>' +
                    '<div>4. íŠ¸ëœì­ì…˜ ID ì—†ìŒ</div>' +
                    '</div></div>' +
                    '<div class="bg-black bg-opacity-30 p-3 rounded mt-2">' +
                    '<p class="font-bold mb-2">ğŸ’¥ ì˜ˆìƒ í”¼í•´:</p>' +
                    '<div class="space-y-1 ml-4 text-xs">' +
                    '<div>â€¢ ì˜ë„í•˜ì§€ ì•Šì€ ì¤‘ë³µ ì†¡ê¸ˆ</div>' +
                    '<div>â€¢ ê³ ê° ë¶ˆë§Œ ë° í™˜ë¶ˆ ìš”ì²­</div>' +
                    '<div>â€¢ ìš´ì˜ ë¹„ìš© ì¦ê°€</div>' +
                    '</div></div>';
            } else {
                problems = 
                    '<div class="bg-black bg-opacity-30 p-3 rounded">' +
                    '<p class="font-bold mb-2">âŒ í¬ì¸íŠ¸ ì¤‘ë³µ ì‚¬ìš©:</p>' +
                    '<div class="space-y-1 ml-4 text-xs">' +
                    '<div>1. í¬ì¸íŠ¸ ì°¨ê° ì›ìì„± ë¯¸ë³´ì¥</div>' +
                    '<div>2. ë‹¤ì¤‘ íƒ­/ë””ë°”ì´ìŠ¤ ë™ì‹œ ì‚¬ìš©</div>' +
                    '<div>3. ë‚™ê´€ì  ë½ ë¯¸ì‚¬ìš©</div>' +
                    '<div>4. ì‚¬ìš© ì´ë ¥ ì¤‘ë³µ ìƒì„±</div>' +
                    '</div></div>' +
                    '<div class="bg-black bg-opacity-30 p-3 rounded mt-2">' +
                    '<p class="font-bold mb-2">ğŸ’¥ ì˜ˆìƒ í”¼í•´:</p>' +
                    '<div class="space-y-1 ml-4 text-xs">' +
                    '<div>â€¢ í¬ì¸íŠ¸ ë¶€ì • ì‚¬ìš©</div>' +
                    '<div>â€¢ ë§ˆì¼€íŒ… ë¹„ìš© ì¦ê°€</div>' +
                    '<div>â€¢ ì•…ìš© ì‚¬ë¡€ í™•ì‚°</div>' +
                    '</div></div>';
            }
            
            document.getElementById('problemContent').innerHTML = problems;
        }

        function updateBalance(balance) {
            currentBalance = balance;
            const color = balance >= 0 ? 'text-green-400' : 'text-red-400';
            document.getElementById('currentBalance').innerHTML = 
                `<span class="${color}">${balance.toLocaleString()}</span>` +
                '<span class="text-gray-400 text-2xl ml-2">ì›</span>';
        }

        function updateStep(html) {
            const steps = document.getElementById('attackSteps');
            const div = document.createElement('div');
            div.className = 'p-2 bg-gray-700 rounded text-sm slide-in';
            div.innerHTML = html;
            steps.appendChild(div);
            steps.scrollTop = steps.scrollHeight;
        }

        async function addServerLog(message, colorClass = 'text-green-400') {
            const div = document.createElement('div');
            div.className = colorClass;
            div.textContent = message;
            const container = document.getElementById('serverLog');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            await sleep(50);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>